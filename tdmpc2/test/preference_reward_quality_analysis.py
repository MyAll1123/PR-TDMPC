#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
åå¥½å¥–åŠ±è´¨é‡è¯†åˆ«é—®é¢˜åˆ†æ

åˆ†æåå¥½å¥–åŠ±æ¨¡å‹ä¸ºä»€ä¹ˆæ— æ³•æœ‰æ•ˆè¯†åˆ«è½¨è¿¹è´¨é‡çš„æ ¹æœ¬åŸå› 
"""

import numpy as np
import torch
import torch.nn as nn
from typing import Dict, List, Tuple
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class PreferenceRewardQualityAnalyzer:
    """åå¥½å¥–åŠ±è´¨é‡è¯†åˆ«åˆ†æå™¨"""
    
    def __init__(self):
        self.analysis_results = {}
        
    def analyze_log_patterns(self):
        """åˆ†ææ—¥å¿—ä¸­çš„æ¨¡å¼"""
        print("\n" + "="*80)
        print("ğŸ” åå¥½å¥–åŠ±è´¨é‡è¯†åˆ«é—®é¢˜åˆ†æ")
        print("="*80)
        
        # ä»æ—¥å¿—ä¸­è§‚å¯Ÿåˆ°çš„é—®é¢˜æ¨¡å¼
        observed_cases = [
            {
                "episode": 3760,
                "env_reward": 69.35,
                "avg_env_reward": 0.5176,
                "preference_reward": -0.0135,
                "positive_prefs": 59,
                "negative_prefs": 75,
                "quality_score": 40.52,
                "survival_time": 134
            },
            {
                "episode": 4020,
                "env_reward": 75.41,
                "avg_env_reward": 0.7541,
                "preference_reward": -0.0334,
                "positive_prefs": 43,
                "negative_prefs": 57,
                "quality_score": 43.21,
                "survival_time": 100
            },
            {
                "episode": 4021,
                "env_reward": 100.70,
                "avg_env_reward": 0.7405,
                "preference_reward": -0.0035,
                "positive_prefs": 63,
                "negative_prefs": 73,
                "quality_score": 62.16,
                "survival_time": 136
            },
            {
                "episode": 4028,
                "env_reward": 102.85,
                "avg_env_reward": 0.6593,
                "preference_reward": -0.0244,
                "positive_prefs": 70,
                "negative_prefs": 86,
                "quality_score": 61.98,
                "survival_time": 156
            },
            {
                "episode": 4031,
                "env_reward": "æœªçŸ¥",
                "avg_env_reward": 0.5307,
                "preference_reward": -0.0495,
                "positive_prefs": 60,
                "negative_prefs": 87,
                "quality_score": "æœªçŸ¥",
                "survival_time": "æœªçŸ¥"
            }
        ]
        
        print("\nğŸ“Š é—®é¢˜æ¡ˆä¾‹åˆ†æ:")
        for i, case in enumerate(observed_cases, 1):
            print(f"\næ¡ˆä¾‹ {i} (Episode {case['episode']}):")
            print(f"  ğŸŒ ç¯å¢ƒå¥–åŠ±: {case['env_reward']} (å¹³å‡: {case['avg_env_reward']:.4f})")
            print(f"  ğŸ§  åå¥½å¥–åŠ±: {case['preference_reward']:.4f}")
            print(f"  âœ… æ­£å‘åå¥½: {case['positive_prefs']} | âš ï¸ è´Ÿå‘åå¥½: {case['negative_prefs']}")
            if case['quality_score'] != "æœªçŸ¥":
                print(f"  ğŸ“ˆ è´¨é‡åˆ†æ•°: {case['quality_score']:.2f}")
            if case['survival_time'] != "æœªçŸ¥":
                print(f"  â±ï¸ ç”Ÿå­˜æ—¶é—´: {case['survival_time']}")
            
            # åˆ†æçŸ›ç›¾
            if case['preference_reward'] < 0 and case['avg_env_reward'] > 0.5:
                print(f"  âš ï¸ çŸ›ç›¾: é«˜ç¯å¢ƒå¥–åŠ±({case['avg_env_reward']:.4f})ä½†è´Ÿåå¥½å¥–åŠ±({case['preference_reward']:.4f})")
        
        return observed_cases
    
    def analyze_root_causes(self):
        """åˆ†ææ ¹æœ¬åŸå› """
        print("\n" + "="*80)
        print("ğŸ” æ ¹æœ¬åŸå› åˆ†æ")
        print("="*80)
        
        causes = {
            "1. åå¥½æ¨¡å‹è®­ç»ƒæ•°æ®è´¨é‡é—®é¢˜": {
                "æè¿°": "åå¥½æ¨¡å‹å¯èƒ½åŸºäºé”™è¯¯æˆ–ä¸ä¸€è‡´çš„åå¥½æ ‡ç­¾è¿›è¡Œè®­ç»ƒ",
                "è¯æ®": [
                    "é«˜ç¯å¢ƒå¥–åŠ±è½¨è¿¹è¢«åˆ¤å®šä¸ºè´Ÿåå¥½",
                    "åå¥½åˆ¤æ–­ä¸å®é™…ä»»åŠ¡è¡¨ç°ä¸ç¬¦",
                    "æ­£è´Ÿåå¥½æ•°é‡æ¥è¿‘ä½†åå¥½å¥–åŠ±ä¸ºè´Ÿ"
                ],
                "å½±å“": "æ¨¡å‹å­¦ä¹ åˆ°é”™è¯¯çš„åå¥½æ¨¡å¼"
            },
            "2. åå¥½å¥–åŠ±æ˜ å°„æœºåˆ¶ç¼ºé™·": {
                "æè¿°": "_map_reward_with_confidenceæ–¹æ³•å¯èƒ½å­˜åœ¨æ˜ å°„é€»è¾‘é—®é¢˜",
                "è¯æ®": [
                    "ç½®ä¿¡åº¦è¾ƒé«˜ä½†å¥–åŠ±æ–¹å‘é”™è¯¯",
                    "å¥–åŠ±èŒƒå›´æ˜ å°„å¯èƒ½ä¸åˆç†",
                    "åŸå§‹åˆ†æ•°ä¸æœ€ç»ˆå¥–åŠ±ä¸åŒ¹é…"
                ],
                "å½±å“": "å³ä½¿æ¨¡å‹è¾“å‡ºæ­£ç¡®ï¼Œæ˜ å°„åç»“æœé”™è¯¯"
            },
            "3. ç‰¹å¾è¡¨ç¤ºä¸å……åˆ†": {
                "æè¿°": "è½¨è¿¹ç¼–ç å™¨å¯èƒ½æ— æ³•æ•è·å…³é”®çš„è´¨é‡ç‰¹å¾",
                "è¯æ®": [
                    "ç›¸ä¼¼ç¯å¢ƒå¥–åŠ±çš„è½¨è¿¹åå¥½åˆ¤æ–­å·®å¼‚å·¨å¤§",
                    "æ¨¡å‹æ— æ³•åŒºåˆ†é«˜è´¨é‡å’Œä½è´¨é‡è½¨è¿¹",
                    "æ½œç©ºé—´è¡¨ç¤ºå¯èƒ½ä¸¢å¤±é‡è¦ä¿¡æ¯"
                ],
                "å½±å“": "æ¨¡å‹åŸºäºä¸å®Œæ•´ä¿¡æ¯åšå‡ºé”™è¯¯åˆ¤æ–­"
            },
            "4. è®­ç»ƒç›®æ ‡ä¸å®é™…ç›®æ ‡ä¸ä¸€è‡´": {
                "æè¿°": "åå¥½å­¦ä¹ ç›®æ ‡å¯èƒ½ä¸ä»»åŠ¡æˆåŠŸç›®æ ‡ä¸ä¸€è‡´",
                "è¯æ®": [
                    "é«˜ä»»åŠ¡è¡¨ç°è½¨è¿¹è¢«åˆ¤å®šä¸ºä¸ç¬¦åˆåå¥½",
                    "åå¥½æ¨¡å‹å¯èƒ½å­¦ä¹ åˆ°å±€éƒ¨æœ€ä¼˜æ¨¡å¼",
                    "è®­ç»ƒæ•°æ®å¯èƒ½å­˜åœ¨æ ‡ç­¾å™ªå£°"
                ],
                "å½±å“": "æ¨¡å‹ä¼˜åŒ–é”™è¯¯çš„ç›®æ ‡å‡½æ•°"
            },
            "5. æ¨¡å‹å®¹é‡å’Œå¤æ‚åº¦é—®é¢˜": {
                "æè¿°": "åå¥½æ¨¡å‹å¯èƒ½è¿‡äºç®€å•ï¼Œæ— æ³•å¤„ç†å¤æ‚çš„åå¥½å…³ç³»",
                "è¯æ®": [
                    "è®­ç»ƒæŸå¤±å±…é«˜ä¸ä¸‹(0.6+)",
                    "æ¨¡å‹å¯èƒ½æ¬ æ‹Ÿåˆæˆ–è¿‡æ‹Ÿåˆ",
                    "æ— æ³•å­¦ä¹ åˆ°ç¨³å®šçš„åå¥½æ¨¡å¼"
                ],
                "å½±å“": "æ¨¡å‹æ³›åŒ–èƒ½åŠ›å·®ï¼Œåˆ¤æ–­ä¸ç¨³å®š"
            }
        }
        
        for cause, details in causes.items():
            print(f"\n{cause}:")
            print(f"  ğŸ“ {details['æè¿°']}")
            print(f"  ğŸ” è¯æ®:")
            for evidence in details['è¯æ®']:
                print(f"    - {evidence}")
            print(f"  ğŸ’¥ å½±å“: {details['å½±å“']}")
        
        return causes
    
    def simulate_preference_mapping_issues(self):
        """æ¨¡æ‹Ÿåå¥½æ˜ å°„é—®é¢˜"""
        print("\n" + "="*80)
        print("ğŸ§ª åå¥½æ˜ å°„æœºåˆ¶é—®é¢˜æ¨¡æ‹Ÿ")
        print("="*80)
        
        # æ¨¡æ‹Ÿå½“å‰çš„æ˜ å°„é€»è¾‘
        def current_mapping(raw_score, confidence):
            """å½“å‰çš„æ˜ å°„é€»è¾‘"""
            if raw_score > 0:
                # æ­£å‘å¥–åŠ±èŒƒå›´ (0.1, 0.4)
                reward = 0.1 + (0.4 - 0.1) * confidence
            else:
                # è´Ÿå‘å¥–åŠ±èŒƒå›´ (-0.4, -0.1)
                reward = -0.1 - (0.4 - 0.1) * confidence
            return reward
        
        # æµ‹è¯•ä¸åŒæƒ…å†µ
        test_cases = [
            {"raw_score": 0.1, "confidence": 0.8, "description": "å¾®å¼±æ­£å‘åŸå§‹åˆ†æ•°ï¼Œé«˜ç½®ä¿¡åº¦"},
            {"raw_score": -0.1, "confidence": 0.8, "description": "å¾®å¼±è´Ÿå‘åŸå§‹åˆ†æ•°ï¼Œé«˜ç½®ä¿¡åº¦"},
            {"raw_score": 0.01, "confidence": 0.6, "description": "æå¾®å¼±æ­£å‘åŸå§‹åˆ†æ•°ï¼Œä¸­ç­‰ç½®ä¿¡åº¦"},
            {"raw_score": -0.01, "confidence": 0.6, "description": "æå¾®å¼±è´Ÿå‘åŸå§‹åˆ†æ•°ï¼Œä¸­ç­‰ç½®ä¿¡åº¦"},
        ]
        
        print("\nğŸ“Š æ˜ å°„ç»“æœåˆ†æ:")
        for case in test_cases:
            mapped_reward = current_mapping(case['raw_score'], case['confidence'])
            print(f"\n{case['description']}:")
            print(f"  åŸå§‹åˆ†æ•°: {case['raw_score']:+.3f}")
            print(f"  ç½®ä¿¡åº¦: {case['confidence']:.3f}")
            print(f"  æ˜ å°„å¥–åŠ±: {mapped_reward:+.3f}")
            
            # åˆ†æé—®é¢˜
            if abs(case['raw_score']) < 0.05 and abs(mapped_reward) > 0.2:
                print(f"  âš ï¸ é—®é¢˜: å¾®å¼±åŸå§‹ä¿¡å·è¢«æ”¾å¤§ä¸ºå¼ºçƒˆåå¥½ä¿¡å·")
        
        print("\nğŸ” æ˜ å°„æœºåˆ¶é—®é¢˜:")
        print("  1. å¾®å¼±çš„åŸå§‹åˆ†æ•°è¢«è¿‡åº¦æ”¾å¤§")
        print("  2. æ²¡æœ‰è€ƒè™‘åŸå§‹åˆ†æ•°çš„ç»å¯¹å€¼å¤§å°")
        print("  3. ç½®ä¿¡åº¦å¯èƒ½ä¸èƒ½çœŸå®åæ˜ åˆ¤æ–­è´¨é‡")
        print("  4. ç¼ºä¹ä¸­æ€§åŒºåŸŸï¼Œå¼ºåˆ¶äºŒåˆ†ç±»")
        
    def analyze_training_loss_pattern(self):
        """åˆ†æè®­ç»ƒæŸå¤±æ¨¡å¼"""
        print("\n" + "="*80)
        print("ğŸ“ˆ è®­ç»ƒæŸå¤±æ¨¡å¼åˆ†æ")
        print("="*80)
        
        # ä»æ—¥å¿—ä¸­è§‚å¯Ÿåˆ°çš„æŸå¤±æ¨¡å¼
        loss_observations = [
            {"step": 739, "loss": 0.669767, "change": "+9.52%", "avg": 0.611611},
            {"step": 740, "loss": 0.654470, "change": "+7.01%", "avg": 0.611669},
            {"step": 741, "loss": 0.676187, "change": "+10.55%", "avg": 0.611756},
            {"step": 791, "loss": 0.653971, "change": "+6.45%", "avg": 0.614415},
            {"step": 792, "loss": 0.640564, "change": "+4.26%", "avg": 0.614448},
            {"step": 793, "loss": 0.641169, "change": "+4.35%", "avg": 0.614481},
        ]
        
        print("\nğŸ“Š æŸå¤±å˜åŒ–è¶‹åŠ¿:")
        for obs in loss_observations:
            print(f"  æ­¥éª¤ {obs['step']}: æŸå¤± {obs['loss']:.6f} ({obs['change']}) | å†å²å¹³å‡ {obs['avg']:.6f}")
        
        print("\nğŸ” æŸå¤±æ¨¡å¼é—®é¢˜:")
        print("  1. æŸå¤±å€¼æŒç»­åé«˜ (0.64-0.68)ï¼Œè¡¨æ˜æ¨¡å‹éš¾ä»¥æ‹Ÿåˆæ•°æ®")
        print("  2. æŸå¤±æ³¢åŠ¨è¾ƒå¤§ï¼Œè®­ç»ƒä¸ç¨³å®š")
        print("  3. å†å²å¹³å‡æŸå¤±æ”¹å–„ç¼“æ…¢")
        print("  4. å¯èƒ½å­˜åœ¨æ ‡ç­¾å™ªå£°æˆ–æ•°æ®è´¨é‡é—®é¢˜")
        
        # åˆ†æå¯èƒ½çš„åŸå› 
        print("\nğŸ’¡ å¯èƒ½åŸå› :")
        print("  1. åå¥½æ ‡ç­¾ä¸ä¸€è‡´æˆ–å­˜åœ¨å™ªå£°")
        print("  2. æ¨¡å‹æ¶æ„ä¸é€‚åˆå½“å‰ä»»åŠ¡")
        print("  3. å­¦ä¹ ç‡æˆ–ä¼˜åŒ–å™¨è®¾ç½®ä¸å½“")
        print("  4. è®­ç»ƒæ•°æ®åˆ†å¸ƒä¸å¹³è¡¡")
        print("  5. ç‰¹å¾è¡¨ç¤ºèƒ½åŠ›ä¸è¶³")
        
    def propose_solutions(self):
        """æå‡ºè§£å†³æ–¹æ¡ˆ"""
        print("\n" + "="*80)
        print("ğŸ’¡ è§£å†³æ–¹æ¡ˆå»ºè®®")
        print("="*80)
        
        solutions = {
            "1. æ”¹è¿›åå¥½æ ‡ç­¾è´¨é‡": [
                "é‡æ–°å®¡æŸ¥åå¥½æ ‡ç­¾ç”Ÿæˆè§„åˆ™",
                "å¢åŠ æ ‡ç­¾ä¸€è‡´æ€§æ£€æŸ¥",
                "å¼•å…¥å¤šè½®æ ‡ç­¾éªŒè¯æœºåˆ¶",
                "è¿‡æ»¤ä½è´¨é‡æˆ–çŸ›ç›¾çš„åå¥½å¯¹"
            ],
            "2. ä¼˜åŒ–åå¥½å¥–åŠ±æ˜ å°„": [
                "å¼•å…¥åŸå§‹åˆ†æ•°ç»å¯¹å€¼é˜ˆå€¼",
                "æ·»åŠ ä¸­æ€§åŒºåŸŸï¼Œé¿å…å¼ºåˆ¶äºŒåˆ†ç±»",
                "æ”¹è¿›ç½®ä¿¡åº¦è®¡ç®—æ–¹æ³•",
                "ä½¿ç”¨æ›´å¹³æ»‘çš„æ˜ å°„å‡½æ•°"
            ],
            "3. å¢å¼ºç‰¹å¾è¡¨ç¤º": [
                "å¢åŠ è½¨è¿¹ç¼–ç å™¨çš„å¤æ‚åº¦",
                "å¼•å…¥æ³¨æ„åŠ›æœºåˆ¶",
                "æ·»åŠ ä»»åŠ¡ç›¸å…³çš„ç‰¹å¾",
                "ä½¿ç”¨é¢„è®­ç»ƒçš„è¡¨ç¤ºå­¦ä¹ "
            ],
            "4. æ”¹è¿›è®­ç»ƒç­–ç•¥": [
                "è°ƒæ•´å­¦ä¹ ç‡å’Œä¼˜åŒ–å™¨",
                "ä½¿ç”¨è¯¾ç¨‹å­¦ä¹ ",
                "å¢åŠ æ­£åˆ™åŒ–",
                "å®æ–½æ—©åœæœºåˆ¶"
            ],
            "5. å¼•å…¥è´¨é‡æ„ŸçŸ¥æœºåˆ¶": [
                "ç»“åˆç¯å¢ƒå¥–åŠ±ä¿¡æ¯",
                "æ·»åŠ ä»»åŠ¡æˆåŠŸç‡æŒ‡æ ‡",
                "ä½¿ç”¨å¤šç›®æ ‡ä¼˜åŒ–",
                "å®æ–½åŠ¨æ€æƒé‡è°ƒæ•´"
            ]
        }
        
        for solution, details in solutions.items():
            print(f"\n{solution}:")
            for detail in details:
                print(f"  â€¢ {detail}")
        
        print("\nğŸ¯ ä¼˜å…ˆçº§å»ºè®®:")
        print("  1. é¦–å…ˆæ£€æŸ¥å’Œæ”¹è¿›åå¥½æ ‡ç­¾è´¨é‡ (æœ€é«˜ä¼˜å…ˆçº§)")
        print("  2. ä¼˜åŒ–åå¥½å¥–åŠ±æ˜ å°„æœºåˆ¶ (é«˜ä¼˜å…ˆçº§)")
        print("  3. å¼•å…¥è´¨é‡æ„ŸçŸ¥æœºåˆ¶ (ä¸­ç­‰ä¼˜å…ˆçº§)")
        print("  4. æ”¹è¿›è®­ç»ƒç­–ç•¥ (ä¸­ç­‰ä¼˜å…ˆçº§)")
        print("  5. å¢å¼ºç‰¹å¾è¡¨ç¤º (ä½ä¼˜å…ˆçº§)")
        
    def run_complete_analysis(self):
        """è¿è¡Œå®Œæ•´åˆ†æ"""
        print("ğŸš€ å¼€å§‹åå¥½å¥–åŠ±è´¨é‡è¯†åˆ«é—®é¢˜å®Œæ•´åˆ†æ...")
        
        # 1. åˆ†ææ—¥å¿—æ¨¡å¼
        observed_cases = self.analyze_log_patterns()
        
        # 2. åˆ†ææ ¹æœ¬åŸå› 
        root_causes = self.analyze_root_causes()
        
        # 3. æ¨¡æ‹Ÿæ˜ å°„é—®é¢˜
        self.simulate_preference_mapping_issues()
        
        # 4. åˆ†æè®­ç»ƒæŸå¤±
        self.analyze_training_loss_pattern()
        
        # 5. æå‡ºè§£å†³æ–¹æ¡ˆ
        self.propose_solutions()
        
        print("\n" + "="*80)
        print("ğŸ“‹ åˆ†ææ€»ç»“")
        print("="*80)
        print("\nğŸ” æ ¸å¿ƒé—®é¢˜:")
        print("  åå¥½å¥–åŠ±æ¨¡å‹æ— æ³•æœ‰æ•ˆè¯†åˆ«è½¨è¿¹è´¨é‡ï¼Œé«˜ç¯å¢ƒå¥–åŠ±è½¨è¿¹è¢«é”™è¯¯åˆ¤å®šä¸ºè´Ÿåå¥½")
        
        print("\nğŸ¯ å…³é”®å‘ç°:")
        print("  1. å­˜åœ¨æ˜æ˜¾çš„åˆ¤æ–­çŸ›ç›¾ï¼šé«˜è´¨é‡è½¨è¿¹ â†’ è´Ÿåå¥½å¥–åŠ±")
        print("  2. è®­ç»ƒæŸå¤±æŒç»­åé«˜ï¼Œæ¨¡å‹æ‹Ÿåˆå›°éš¾")
        print("  3. åå¥½æ˜ å°„æœºåˆ¶å¯èƒ½è¿‡åº¦æ”¾å¤§å¾®å¼±ä¿¡å·")
        print("  4. ç¼ºä¹æœ‰æ•ˆçš„è´¨é‡æ„ŸçŸ¥æœºåˆ¶")
        
        print("\nğŸ’¡ å»ºè®®è¡ŒåŠ¨:")
        print("  1. ç«‹å³æ£€æŸ¥åå¥½æ ‡ç­¾ç”Ÿæˆé€»è¾‘")
        print("  2. ä¼˜åŒ–åå¥½å¥–åŠ±æ˜ å°„å‡½æ•°")
        print("  3. å¼•å…¥ç¯å¢ƒå¥–åŠ±ä½œä¸ºè´¨é‡å‚è€ƒ")
        print("  4. å®æ–½æ›´ä¸¥æ ¼çš„æ•°æ®è´¨é‡æ§åˆ¶")
        
        print("\nâœ… åˆ†æå®Œæˆï¼")

if __name__ == "__main__":
    analyzer = PreferenceRewardQualityAnalyzer()
    analyzer.run_complete_analysis()