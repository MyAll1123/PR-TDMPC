#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ä¸ºä»€ä¹ˆåå¥½å¥–åŠ±æ¨¡å‹æ°¸è¿œåªæœ‰æ­£å‘å’Œè´Ÿå‘åå¥½ï¼Ÿ
è¯¦ç»†è§£é‡Šåå¥½å¥–åŠ±æ¨¡å‹çš„è®¾è®¡åŸç†å’Œä¸è¾“å‡ºä¸­æ€§å€¼çš„åŸå› 
"""

import torch
import numpy as np
import sys
import os

# æ·»åŠ é¡¹ç›®è·¯å¾„
sys.path.append('/public/home/yaotianxiao2024/SPE')
sys.path.append('/public/home/yaotianxiao2024/SPE/prm')

from prm.optimized_latent_preference_model import (
    OptimizedLatentPreferenceConfig,
    create_optimized_latent_preference_model
)

def explain_no_neutral_preference():
    """
    è¯¦ç»†è§£é‡Šä¸ºä»€ä¹ˆåå¥½å¥–åŠ±æ¨¡å‹ä¸è¾“å‡ºä¸­æ€§/ä¸ç¡®å®šçš„ç»“æœ
    """
    print("="*80)
    print("ä¸ºä»€ä¹ˆåå¥½å¥–åŠ±æ¨¡å‹æ°¸è¿œåªæœ‰æ­£å‘å’Œè´Ÿå‘åå¥½ï¼Ÿ")
    print("="*80)
    
    print("\nğŸ¤” ç”¨æˆ·çš„ç–‘é—®ï¼š")
    print("   æ­£å¸¸æ¥è¯´ä¸æ˜¯æœ‰äº›è¡Œä¸ºä¸æ˜æ˜¾æ— æ³•åˆ¤æ–­å—ï¼Ÿä¸ºä»€ä¹ˆä¸è¾“å‡º'æ— æ³•åˆ¤æ–­'æˆ–ä¸­æ€§ç»“æœï¼Ÿ")
    
    print("\nğŸ“‹ ç­”æ¡ˆæ¦‚è§ˆï¼š")
    print("   1. è¿™æ˜¯åå¥½å­¦ä¹ çš„æœ¬è´¨ç‰¹æ€§ï¼Œä¸æ˜¯è®¾è®¡ç¼ºé™·")
    print("   2. åå¥½æ¨¡å‹é€šè¿‡ç½®ä¿¡åº¦æ¥è¡¨è¾¾ä¸ç¡®å®šæ€§ï¼Œè€Œä¸æ˜¯é›¶å€¼")
    print("   3. å¼ºåˆ¶äºŒå…ƒé€‰æ‹©æœ‰åŠ©äºæ¨¡å‹å­¦ä¹ æ›´æ˜ç¡®çš„åå¥½è¾¹ç•Œ")
    print("   4. åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ç½®ä¿¡åº¦å·²ç»èµ·åˆ°äº†'ä¸ç¡®å®š'çš„ä½œç”¨")
    
    print("\n" + "="*80)
    print("è¯¦ç»†åˆ†æ")
    print("="*80)
    
    # 1. åå¥½å­¦ä¹ çš„æœ¬è´¨
    print("\n1ï¸âƒ£ åå¥½å­¦ä¹ çš„æœ¬è´¨ç‰¹æ€§")
    print("-"*50)
    print("   åå¥½å­¦ä¹ (Preference Learning)çš„æ ¸å¿ƒæ˜¯å­¦ä¹ 'ç›¸å¯¹æ¯”è¾ƒ'ï¼š")
    print("   â€¢ ç»™å®šä¸¤ä¸ªé€‰é¡¹Aå’ŒBï¼Œæ¨¡å‹å¿…é¡»åˆ¤æ–­å“ªä¸ªæ›´å¥½")
    print("   â€¢ è¿™æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªäºŒå…ƒåˆ†ç±»é—®é¢˜ï¼šA>B æˆ– B>A")
    print("   â€¢ å³ä½¿åœ¨ä¸ç¡®å®šçš„æƒ…å†µä¸‹ï¼Œæ¨¡å‹ä¹Ÿå¿…é¡»åšå‡ºé€‰æ‹©")
    print("   â€¢ è¿™ç§'å¼ºåˆ¶é€‰æ‹©'æœºåˆ¶è¿«ä½¿æ¨¡å‹å­¦ä¹ ç»†å¾®çš„åå¥½å·®å¼‚")
    
    print("\n   ğŸ“š ç†è®ºä¾æ®ï¼š")
    print("   â€¢ Bradley-Terryæ¨¡å‹ï¼šP(A>B) = exp(f(A)) / (exp(f(A)) + exp(f(B)))")
    print("   â€¢ è¯¥æ¨¡å‹æ€»æ˜¯è¾“å‡ºä¸€ä¸ªæ¦‚ç‡å€¼ï¼Œä¸å­˜åœ¨'æ— æ³•æ¯”è¾ƒ'çš„æƒ…å†µ")
    print("   â€¢ äººç±»åå¥½æ ‡æ³¨ä¹Ÿæ˜¯å¦‚æ­¤ï¼šå³ä½¿å¾ˆéš¾åˆ¤æ–­ï¼Œæ ‡æ³¨è€…ä¹Ÿå¿…é¡»é€‰æ‹©ä¸€ä¸ª")
    
    # 2. ç½®ä¿¡åº¦æœºåˆ¶
    print("\n2ï¸âƒ£ ç½®ä¿¡åº¦æœºåˆ¶ï¼šç”¨æ¦‚ç‡è¡¨è¾¾ä¸ç¡®å®šæ€§")
    print("-"*50)
    print("   åå¥½æ¨¡å‹é€šè¿‡ç½®ä¿¡åº¦æ¥è¡¨è¾¾ä¸ç¡®å®šæ€§ï¼Œè€Œä¸æ˜¯è¾“å‡ºé›¶å€¼ï¼š")
    print("   â€¢ é«˜ç½®ä¿¡åº¦(â‰¥0.7)ï¼šæ¨¡å‹å¾ˆç¡®å®šè¿™ä¸ªåˆ¤æ–­ï¼Œç»™å‡ºå¼ºçƒˆåå¥½(Â±0.4)")
    print("   â€¢ ä½ç½®ä¿¡åº¦(â‰¤0.4)ï¼šæ¨¡å‹ä¸å¤ªç¡®å®šï¼Œç»™å‡ºå¾®å¼±åå¥½(Â±0.1)")
    print("   â€¢ ä¸­ç­‰ç½®ä¿¡åº¦ï¼šçº¿æ€§æ’å€¼ï¼Œåæ˜ ä¸­ç­‰ç¨‹åº¦çš„ç¡®å®šæ€§")
    
    print("\n   ğŸ¯ å…³é”®æ´å¯Ÿï¼š")
    print("   â€¢ ä½ç½®ä¿¡åº¦çš„å¾®å¼±åå¥½ â‰ˆ 'æˆ‘ä¸å¤ªç¡®å®šï¼Œä½†ç¨å¾®å€¾å‘äºè¿™ä¸ªæ–¹å‘'")
    print("   â€¢ è¿™æ¯”ç›´æ¥è¾“å‡ºé›¶å€¼æ›´æœ‰ä¿¡æ¯é‡")
    print("   â€¢ é›¶å€¼æ„å‘³ç€'å®Œå…¨ä¸­æ€§'ï¼Œä½†ç°å®ä¸­å¾ˆå°‘å­˜åœ¨å®Œå…¨ä¸­æ€§çš„è¡Œä¸º")
    
    # 3. æ¼”ç¤ºç½®ä¿¡åº¦çš„ä½œç”¨
    print("\n3ï¸âƒ£ å®é™…æ¼”ç¤ºï¼šç½®ä¿¡åº¦å¦‚ä½•è¡¨è¾¾ä¸ç¡®å®šæ€§")
    print("-"*50)
    
    # åˆ›å»ºæ¨¡å‹
    config = OptimizedLatentPreferenceConfig(
        latent_dim=512,
        action_dim=61,
        hidden_dim=256,
        enable_uncertainty=True
    )
    model = create_optimized_latent_preference_model(config)
    
    print("   æ¨¡æ‹Ÿä¸åŒç¡®å®šæ€§ç¨‹åº¦çš„åˆ¤æ–­ï¼š")
    
    scenarios = [
        ("æ˜æ˜¾å¥½çš„è¡Œä¸º", 2.5, 0.9),
        ("æ˜æ˜¾åçš„è¡Œä¸º", -2.1, 0.85),
        ("ç¨å¾®å¥½ä¸€ç‚¹çš„è¡Œä¸º", 0.3, 0.45),
        ("ç¨å¾®åä¸€ç‚¹çš„è¡Œä¸º", -0.2, 0.35),
        ("å¾ˆéš¾åˆ¤æ–­çš„è¡Œä¸ºA", 0.05, 0.25),
        ("å¾ˆéš¾åˆ¤æ–­çš„è¡Œä¸ºB", -0.03, 0.22),
    ]
    
    for scenario, raw_reward, confidence in scenarios:
        mapped_reward = model._map_reward_with_confidence(raw_reward, confidence)
        
        print(f"\n   {scenario}:")
        print(f"     åŸå§‹åˆ†æ•°: {raw_reward:+.2f}, ç½®ä¿¡åº¦: {confidence:.2f}")
        print(f"     æœ€ç»ˆå¥–åŠ±: {mapped_reward:+.3f}")
        
        if confidence >= 0.7:
            certainty = "é«˜ç¡®å®šæ€§"
        elif confidence <= 0.4:
            certainty = "ä½ç¡®å®šæ€§(æ¥è¿‘ä¸ç¡®å®š)"
        else:
            certainty = "ä¸­ç­‰ç¡®å®šæ€§"
            
        print(f"     è§£é‡Š: {certainty} - {'å¼ºçƒˆ' if abs(mapped_reward) > 0.25 else 'å¾®å¼±'}{'æ­£å‘' if mapped_reward > 0 else 'è´Ÿå‘'}åå¥½")
    
    # 4. ä¸ºä»€ä¹ˆä¸ç”¨é›¶å€¼
    print("\n4ï¸âƒ£ ä¸ºä»€ä¹ˆä¸ä½¿ç”¨é›¶å€¼è¡¨ç¤º'æ— æ³•åˆ¤æ–­'ï¼Ÿ")
    print("-"*50)
    print("   ä½¿ç”¨é›¶å€¼çš„é—®é¢˜ï¼š")
    print("   âŒ ä¿¡æ¯æŸå¤±ï¼šé›¶å€¼ä¸¢å¤±äº†æ¨¡å‹çš„å€¾å‘æ€§åˆ¤æ–­")
    print("   âŒ è®­ç»ƒå›°éš¾ï¼šé›¶å€¼åŒºåŸŸéš¾ä»¥æä¾›æœ‰æ•ˆçš„æ¢¯åº¦ä¿¡å·")
    print("   âŒ ä¸ç¬¦åˆç°å®ï¼šå³ä½¿ä¸ç¡®å®šï¼Œé€šå¸¸ä¹Ÿæœ‰è½»å¾®å€¾å‘")
    print("   âŒ ç»Ÿè®¡é—®é¢˜ï¼šé›¶å€¼ä¼šå¹²æ‰°åå¥½ç»Ÿè®¡å’Œå¥–åŠ±èåˆ")
    
    print("\n   ä½¿ç”¨ç½®ä¿¡åº¦+å¾®å¼±åå¥½çš„ä¼˜åŠ¿ï¼š")
    print("   âœ… ä¿ç•™ä¿¡æ¯ï¼šå³ä½¿ä¸ç¡®å®šä¹Ÿä¿ç•™æ–¹å‘ä¿¡æ¯")
    print("   âœ… å¹³æ»‘æ¢¯åº¦ï¼šè¿ç»­çš„å¥–åŠ±å€¼æä¾›æ›´å¥½çš„è®­ç»ƒä¿¡å·")
    print("   âœ… ç¬¦åˆç›´è§‰ï¼š'ä¸å¤ªç¡®å®šä½†ç¨å¾®å€¾å‘äºX'æ›´ç¬¦åˆäººç±»åˆ¤æ–­")
    print("   âœ… ç»Ÿè®¡å‹å¥½ï¼šæ‰€æœ‰å€¼éƒ½å‚ä¸ç»Ÿè®¡ï¼Œé¿å…ç‰¹æ®Šæƒ…å†µå¤„ç†")
    
    # 5. å®é™…æ•ˆæœåˆ†æ
    print("\n5ï¸âƒ£ å®é™…æ•ˆæœï¼šä½ç½®ä¿¡åº¦å¦‚ä½•èµ·åˆ°'ä¸ç¡®å®š'çš„ä½œç”¨")
    print("-"*50)
    
    print("   åœ¨å¥–åŠ±èåˆä¸­çš„è¡¨ç°ï¼š")
    print("   â€¢ é«˜ç½®ä¿¡åº¦åå¥½ï¼šå¯¹ç¯å¢ƒå¥–åŠ±æœ‰æ˜¾è‘—å½±å“")
    print("   â€¢ ä½ç½®ä¿¡åº¦åå¥½ï¼šå¯¹ç¯å¢ƒå¥–åŠ±å½±å“å¾ˆå°ï¼Œæ¥è¿‘'æ— å½±å“'")
    print("   â€¢ ä¿®æ­£å› å­è®¡ç®—ï¼šä½ç½®ä¿¡åº¦çš„è´¡çŒ®è¢«å¤§å¹…å‰Šå¼±")
    
    # æ¨¡æ‹Ÿè½¨è¿¹ç»Ÿè®¡
    print("\n   æ¨¡æ‹Ÿè½¨è¿¹ç¤ºä¾‹ï¼š")
    trajectory_length = 10
    positive_count = 0
    negative_count = 0
    total_confidence = 0
    
    print("   æ­¥éª¤  |  å¥–åŠ±   | ç½®ä¿¡åº¦ | è´¡çŒ®æƒé‡")
    print("   " + "-"*35)
    
    for step in range(trajectory_length):
        # æ¨¡æ‹Ÿä¸€äº›ä¸ç¡®å®šçš„æ­¥éª¤
        if step < 3:  # å‰å‡ æ­¥æ¯”è¾ƒç¡®å®š
            raw_reward = np.random.choice([1.5, -1.2])
            confidence = np.random.uniform(0.7, 0.9)
        else:  # åé¢æ­¥éª¤ä¸å¤ªç¡®å®š
            raw_reward = np.random.uniform(-0.5, 0.5)
            confidence = np.random.uniform(0.2, 0.5)
            
        mapped_reward = model._map_reward_with_confidence(raw_reward, confidence)
        
        if mapped_reward > 0:
            positive_count += 1
        else:
            negative_count += 1
            
        total_confidence += confidence
        
        print(f"   {step+1:2d}    | {mapped_reward:+.3f} |  {confidence:.2f}  |   {confidence:.2f}")
    
    avg_confidence = total_confidence / trajectory_length
    correction_factor = ((positive_count - negative_count) / trajectory_length) * avg_confidence
    
    print(f"\n   ç»Ÿè®¡ç»“æœï¼š")
    print(f"   â€¢ æ­£å‘åå¥½æ­¥æ•°: {positive_count}")
    print(f"   â€¢ è´Ÿå‘åå¥½æ­¥æ•°: {negative_count}")
    print(f"   â€¢ å¹³å‡ç½®ä¿¡åº¦: {avg_confidence:.3f}")
    print(f"   â€¢ ä¿®æ­£å› å­: {correction_factor:+.3f}")
    
    if abs(correction_factor) < 0.1:
        print(f"   â€¢ è§£é‡Š: ç”±äºç½®ä¿¡åº¦è¾ƒä½ï¼Œä¿®æ­£å› å­å¾ˆå°ï¼Œæ¥è¿‘'æ— å½±å“'")
    else:
        print(f"   â€¢ è§£é‡Š: ä¿®æ­£å› å­æ˜¾è‘—ï¼Œè¯´æ˜è½¨è¿¹æœ‰æ˜ç¡®çš„åå¥½å€¾å‘")
    
    # 6. è®¾è®¡åˆç†æ€§
    print("\n6ï¸âƒ£ è®¾è®¡åˆç†æ€§ï¼šä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡æ˜¯å¯¹çš„")
    print("-"*50)
    print("   ä»æœºå™¨å­¦ä¹ è§’åº¦ï¼š")
    print("   â€¢ è¿ç»­è¾“å‡ºç©ºé—´æ¯”ç¦»æ•£ç©ºé—´æ›´å®¹æ˜“ä¼˜åŒ–")
    print("   â€¢ ç½®ä¿¡åº¦æä¾›äº†æ¯”ç¡¬é˜ˆå€¼æ›´çµæ´»çš„ä¸ç¡®å®šæ€§è¡¨è¾¾")
    print("   â€¢ é¿å…äº†é›¶å€¼å¸¦æ¥çš„æ¢¯åº¦æ¶ˆå¤±é—®é¢˜")
    
    print("\n   ä»åº”ç”¨è§’åº¦ï¼š")
    print("   â€¢ å³ä½¿æ˜¯'ä¸ç¡®å®š'çš„åˆ¤æ–­ä¹ŸåŒ…å«æœ‰ç”¨ä¿¡æ¯")
    print("   â€¢ å¾®å¼±åå¥½æ¯”å®Œå…¨å¿½ç•¥æ›´ç¬¦åˆå®é™…éœ€æ±‚")
    print("   â€¢ ç»Ÿè®¡ä¸Šæ›´ç¨³å®šï¼Œé¿å…äº†é›¶å€¼çš„ç‰¹æ®Šå¤„ç†")
    
    print("\n   ä»äººç±»è®¤çŸ¥è§’åº¦ï¼š")
    print("   â€¢ äººç±»å¾ˆå°‘è¯´'å®Œå…¨æ— æ³•åˆ¤æ–­'ï¼Œé€šå¸¸æ˜¯'ä¸å¤ªç¡®å®šä½†ç¨å¾®å€¾å‘äº...'")
    print("   â€¢ å¼ºåˆ¶é€‰æ‹©èƒ½å¤ŸæŒ–æ˜æ½œåœ¨çš„åå¥½ä¿¡å·")
    print("   â€¢ ç½®ä¿¡åº¦è‡ªç„¶åœ°è¡¨è¾¾äº†åˆ¤æ–­çš„ç¡®å®šç¨‹åº¦")
    
    # 7. æ€»ç»“
    print("\n" + "="*80)
    print("ğŸ¯ æ€»ç»“")
    print("="*80)
    print("\nåå¥½å¥–åŠ±æ¨¡å‹ä¸è¾“å‡ºä¸­æ€§å€¼çš„åŸå› ï¼š")
    print("\n1. ğŸ“Š æœ¬è´¨ç‰¹æ€§ï¼šåå¥½å­¦ä¹ æœ¬è´¨ä¸Šæ˜¯æ¯”è¾ƒä»»åŠ¡ï¼Œå¿…é¡»åšå‡ºé€‰æ‹©")
    print("2. ğŸ² ä¸ç¡®å®šæ€§è¡¨è¾¾ï¼šé€šè¿‡ç½®ä¿¡åº¦è€Œéé›¶å€¼è¡¨è¾¾ä¸ç¡®å®šæ€§æ›´ç§‘å­¦")
    print("3. ğŸ”„ è®­ç»ƒæ•ˆæœï¼šè¿ç»­è¾“å‡ºç©ºé—´æä¾›æ›´å¥½çš„æ¢¯åº¦ä¿¡å·")
    print("4. ğŸ“ˆ å®é™…åº”ç”¨ï¼šä½ç½®ä¿¡åº¦çš„å¾®å¼±åå¥½åœ¨å®é™…ä¸­èµ·åˆ°'æ¥è¿‘ä¸­æ€§'çš„ä½œç”¨")
    print("5. ğŸ§  è®¤çŸ¥ç¬¦åˆï¼šç¬¦åˆäººç±»'å€¾å‘æ€§åˆ¤æ–­'çš„è®¤çŸ¥æ¨¡å¼")
    
    print("\nğŸ’¡ å…³é”®æ´å¯Ÿï¼š")
    print("   'ä¸ç¡®å®š'ä¸ç­‰äº'ä¸­æ€§'ï¼")
    print("   â€¢ ä¸ç¡®å®šï¼šæˆ‘ä¸å¤ªç¡®å®šï¼Œä½†ç¨å¾®å€¾å‘äºX (ä½ç½®ä¿¡åº¦ + å¾®å¼±åå¥½)")
    print("   â€¢ ä¸­æ€§ï¼šæˆ‘è®¤ä¸ºä¸¤è€…å®Œå…¨ä¸€æ · (è¿™åœ¨ç°å®ä¸­å¾ˆå°‘å­˜åœ¨)")
    
    print("\nğŸ‰ ç»“è®ºï¼š")
    print("   å½“å‰çš„è®¾è®¡æ˜¯åˆç†çš„ï¼é€šè¿‡ç½®ä¿¡åº¦æœºåˆ¶ï¼Œæ¨¡å‹å·²ç»èƒ½å¤Ÿæœ‰æ•ˆåœ°")
    print("   å¤„ç†ä¸ç¡®å®šæƒ…å†µï¼Œè€Œä¸éœ€è¦å¼•å…¥å¯èƒ½å¸¦æ¥é—®é¢˜çš„é›¶å€¼è¾“å‡ºã€‚")
    
    print("\n" + "="*80)

if __name__ == "__main__":
    explain_no_neutral_preference()